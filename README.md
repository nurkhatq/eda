# Goszakup ETL System

–°–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–∫—É–ø–∫–∞—Ö –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ —á–µ—Ä–µ–∑ API goszakup.gov.kz.

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ö–∞–∫–∞—Ç–æ–Ω–∞ ForteBank –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è:
- –°–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ –≤—Å–µ—Ö 74 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ API goszakup.gov.kz
- –•—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ ETL –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —á–µ—Ä–µ–∑ Apache Airflow
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Goszakup API   ‚îÇ
‚îÇ  (74 endpoints) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Apache Airflow  ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 02:00
‚îÇ   (Scheduler)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETL Scripts    ‚îÇ
‚îÇ (Python)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL     ‚îÇ
‚îÇ  (goszakup DB)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PgAdmin       ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
eda/
‚îú‚îÄ‚îÄ dags/                          # Airflow DAGs
‚îÇ   ‚îî‚îÄ‚îÄ goszakup_etl_dag.py       # –û—Å–Ω–æ–≤–Ω–æ–π ETL –ø–∞–π–ø–ª–∞–π–Ω
‚îú‚îÄ‚îÄ src/                           # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ goszakup_client.py        # API –∫–ª–∏–µ–Ω—Ç (74 —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞)
‚îÇ   ‚îî‚îÄ‚îÄ database.py               # –ú–æ–¥—É–ª—å —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îú‚îÄ‚îÄ sql/                           # SQL —Å–∫—Ä–∏–ø—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ init_schema.sql           # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º—ã –ë–î
‚îú‚îÄ‚îÄ data/                          # –î–∞–Ω–Ω—ã–µ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
‚îú‚îÄ‚îÄ logs/                          # –õ–æ–≥–∏ Airflow
‚îú‚îÄ‚îÄ config/                        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ docker-compose.yml            # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ requirements.txt              # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .env                          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ README.md                     # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã API (74 —à—Ç—É–∫–∏)

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö:
1. **GraphQL** - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –∑–∞–ø—Ä–æ—Å—ã (2)
2. **–ñ—É—Ä–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (1)
3. **–†–µ–µ—Å—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤** - –ö–æ–º–ø–∞–Ω–∏–∏, –∞–¥—Ä–µ—Å–∞, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (6)
4. **–†–ù–£** - –ù–µ–¥–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ (2)
5. **–ü–ª–∞–Ω—ã –∑–∞–∫—É–ø–æ–∫** - –ì–æ–¥–æ–≤—ã–µ –ø–ª–∞–Ω—ã –∑–∞–∫–∞–∑—á–∏–∫–æ–≤ (7)
6. **–û–±—ä—è–≤–ª–µ–Ω–∏—è** - –û–±—ä—è–≤–ª–µ–Ω–∏—è –æ –∑–∞–∫—É–ø–∫–∞—Ö (8)
7. **–ó–∞—è–≤–∫–∏** - –ó–∞—è–≤–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (1)
8. **–õ–æ—Ç—ã** - –õ–æ—Ç—ã –∑–∞–∫—É–ø–æ–∫ (4)
9. **–î–æ–≥–æ–≤–æ—Ä—ã** - –î–æ–≥–æ–≤–æ—Ä—ã –∏ –∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ã (9)
10. **–ê–∫—Ç—ã** - –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∞–∫—Ç—ã (2)
11. **–ü–ª–∞—Ç–µ–∂–∏** - –ö–∞–∑–Ω–∞—á–µ–π—Å–∫–∏–µ –ø–ª–∞—Ç–µ–∂–∏ (2)
12. **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏** - 30 —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤

–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Å–º. –≤ `api_documentation.json`

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker 20.10+
- Docker Compose 2.0+
- –ú–∏–Ω–∏–º—É–º 4GB RAM
- 20GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞

```bash
cd /home/user/eda
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–§–∞–π–ª `.env` —É–∂–µ —Å–æ–∑–¥–∞–Ω —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:

```env
AIRFLOW_UID=50000
GOSZAKUP_DB_HOST=postgres-goszakup
GOSZAKUP_DB_NAME=goszakup
GOSZAKUP_DB_USER=goszakup
GOSZAKUP_DB_PASSWORD=goszakup123
```

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ.

### 3. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p logs data

# –ó–∞–ø—É—Å–∫–∞–µ–º Docker Compose
docker-compose up -d
```

–≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç:
- PostgreSQL (–ø–æ—Ä—Ç 5432) - –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
- PostgreSQL (–ø–æ—Ä—Ç 5433) - –ë–î –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö Airflow
- Apache Airflow Webserver (–ø–æ—Ä—Ç 8080)
- Apache Airflow Scheduler
- PgAdmin (–ø–æ—Ä—Ç 5050) - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ë–î

### 4. –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 2-3 –º–∏–Ω—É—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:

```bash
docker-compose ps
```

–í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å—Ç–∞—Ç—É—Å–µ "Up".

### 5. –î–æ—Å—Ç—É–ø –∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º

#### Airflow
- URL: http://localhost:8080
- –õ–æ–≥–∏–Ω: `admin`
- –ü–∞—Ä–æ–ª—å: `admin`

#### PgAdmin
- URL: http://localhost:5050
- Email: `admin@admin.com`
- –ü–∞—Ä–æ–ª—å: `admin`

### 6. –ó–∞–ø—É—Å–∫ ETL –ø—Ä–æ—Ü–µ—Å—Å–∞

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Airflow UI

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080
2. –ù–∞–π–¥–∏—Ç–µ DAG `goszakup_full_etl`
3. –í–∫–ª—é—á–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º
4. –ù–∞–∂–º–∏—Ç–µ "Trigger DAG" –¥–ª—è –∑–∞–ø—É—Å–∫–∞

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É

```bash
# –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ DAG
docker exec -it goszakup_airflow_scheduler airflow dags trigger goszakup_full_etl
```

#### –í–∞—Ä–∏–∞–Ω—Ç C: –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

```bash
# –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker exec -it goszakup_airflow_webserver bash

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Python —Å–∫—Ä–∏–ø—Ç
cd /opt/airflow/src
python3 -c "
from goszakup_client import GoszakupAPIClient
from database import GoszakupDB, GoszakupETL
import os

# –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç API
api = GoszakupAPIClient()

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î
db = GoszakupDB(
    host=os.getenv('GOSZAKUP_DB_HOST'),
    port=5432,
    database=os.getenv('GOSZAKUP_DB_NAME'),
    user=os.getenv('GOSZAKUP_DB_USER'),
    password=os.getenv('GOSZAKUP_DB_PASSWORD')
)
db.connect()

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—ã–π ETL
etl = GoszakupETL(api, db)
etl.run_full_etl()

db.close()
"
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (—Å JSONB):

- `subjects` - –£—á–∞—Å—Ç–Ω–∏–∫–∏ (–∫–æ–º–ø–∞–Ω–∏–∏)
- `rnu` - –†–µ–µ—Å—Ç—Ä –Ω–µ–¥–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
- `plans` - –ü–ª–∞–Ω—ã –∑–∞–∫—É–ø–æ–∫
- `announcements` - –û–±—ä—è–≤–ª–µ–Ω–∏—è –æ –∑–∞–∫—É–ø–∫–∞—Ö
- `applications` - –ó–∞—è–≤–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
- `lots` - –õ–æ—Ç—ã
- `contracts` - –î–æ–≥–æ–≤–æ—Ä—ã
- `acts` - –ê–∫—Ç—ã –ø—Ä–∏–µ–º–∫–∏-–ø–µ—Ä–µ–¥–∞—á–∏
- `payments` - –ü–ª–∞—Ç–µ–∂–∏

### –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (30 —Ç–∞–±–ª–∏—Ü):

–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ `ref_*`:
- `ref_trade_methods` - –°–ø–æ—Å–æ–±—ã –∑–∞–∫—É–ø–∫–∏
- `ref_buy_status` - –°—Ç–∞—Ç—É—Å—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- `ref_contract_status` - –°—Ç–∞—Ç—É—Å—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤
- –ò —Ç.–¥.

### –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views):

- `v_subjects` - –£–¥–æ–±–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- `v_contracts` - –£–¥–æ–±–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–≥–æ–≤–æ—Ä–æ–≤
- `v_announcements` - –£–¥–æ–±–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏–π

## –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –Ω–∞–ø—Ä—è–º—É—é

```bash
# –ß–µ—Ä–µ–∑ psql
docker exec -it goszakup_postgres_data psql -U goszakup -d goszakup

# –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
SELECT COUNT(*) FROM subjects;

# –¢–æ–ø 10 –∑–∞–∫–∞–∑—á–∏–∫–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–æ–≥–æ–≤–æ—Ä–æ–≤
SELECT
    data->>'customer_bin' as bin,
    COUNT(*) as contract_count
FROM contracts
GROUP BY data->>'customer_bin'
ORDER BY contract_count DESC
LIMIT 10;

# –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ –ë–ò–ù
SELECT
    data->>'name_ru' as name,
    data->>'email' as email
FROM subjects
WHERE data->>'bin' = '071140005693';
```

### –ß–µ—Ä–µ–∑ PgAdmin

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:5050
2. Add New Server:
   - Name: Goszakup
   - Host: postgres-goszakup
   - Port: 5432
   - Database: goszakup
   - Username: goszakup
   - Password: goszakup123

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –õ–æ–≥–∏ Airflow

```bash
# –í—Å–µ –ª–æ–≥–∏
docker-compose logs -f

# –¢–æ–ª—å–∫–æ scheduler
docker-compose logs -f airflow-scheduler

# –¢–æ–ª—å–∫–æ webserver
docker-compose logs -f airflow-webserver
```

### –õ–æ–≥–∏ ETL –ø—Ä–æ—Ü–µ—Å—Å–∞

–õ–æ–≥–∏ —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Airflow UI:
1. –û—Ç–∫—Ä–æ–π—Ç–µ DAG `goszakup_full_etl`
2. –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø—É—Å–∫ (Run)
3. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∑–∞–¥–∞—á—É (Task)
4. –ù–∞–∂–º–∏—Ç–µ "Log"

## –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ ETL

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é DAG –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 02:00**.

–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `schedule_interval` –≤ `dags/goszakup_etl_dag.py`:

```python
dag = DAG(
    'goszakup_full_etl',
    schedule_interval='0 2 * * *',  # Cron —Ñ–æ—Ä–º–∞—Ç
    ...
)
```

–ü—Ä–∏–º–µ—Ä—ã:
- `'0 */6 * * *'` - –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
- `'0 0 * * 0'` - –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
- `'@hourly'` - –∫–∞–∂–¥—ã–π —á–∞—Å

## –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
docker-compose down
```

### –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è –¥–∞–Ω–Ω—ã–µ)

```bash
docker-compose down -v
```

‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ**: —ç—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î!

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞

1. –î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç–æ–¥ –≤ `src/goszakup_client.py`:

```python
def get_new_endpoint(self) -> List[Dict]:
    """–û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞"""
    return self._paginate('/v3/new-endpoint')
```

2. –î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ `src/database.py`:

```python
def load_new_data(self):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    logger.info("–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...")
    try:
        data = self.api.get_new_endpoint()
        if data:
            self.db.insert_jsonb_batch('new_table', data)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞: {e}")
```

3. –î–æ–±–∞–≤—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ `sql/init_schema.sql`:

```sql
CREATE TABLE new_table (
    id SERIAL PRIMARY KEY,
    data JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_new_table_data ON new_table USING GIN (data);
```

4. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É –≤ `dags/goszakup_etl_dag.py`

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏

–í `.env` –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

```env
ETL_BATCH_SIZE=1000        # –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
ETL_RETRY_COUNT=3          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ
ETL_DELAY_SECONDS=1        # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
```

### –ò–Ω–¥–µ–∫—Å—ã

–í—Å–µ –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ `init_schema.sql`:
- –ë–ò–ù/–ò–ò–ù —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ù–æ–º–µ—Ä–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤
- –°—Ç–∞—Ç—É—Å—ã
- –ò —Ç.–¥.

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: Airflow –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker-compose logs airflow-init

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down
docker-compose up -d
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
docker-compose ps postgres-goszakup

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ë–î
docker-compose logs postgres-goszakup

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ë–î
docker-compose restart postgres-goszakup
```

### –ü—Ä–æ–±–ª–µ–º–∞: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å https://ows.goszakup.gov.kz
- –£–≤–µ–ª–∏—á—å—Ç–µ `ETL_DELAY_SECONDS` –≤ `.env`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω—É–∂–µ–Ω –ª–∏ —Ç–æ–∫–µ–Ω –¥–ª—è API

## API Rate Limits

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏. –ï—Å–ª–∏ API –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã:

1. –£–≤–µ–ª–∏—á—å—Ç–µ `ETL_DELAY_SECONDS` –≤ `.env`
2. –£–º–µ–Ω—å—à–∏—Ç–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –≤ DAG
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ API —Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

## –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ:

1. **Jupyter Notebook** - –ø–æ–¥–∫–ª—é—á–∏—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
2. **PowerBI / Tableau** - –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫ PostgreSQL
3. **Metabase** - –¥–æ–±–∞–≤–∏—Ç—å –≤ docker-compose.yml –¥–ª—è –¥–∞—à–±–æ—Ä–¥–æ–≤
4. **Python —Å–∫—Ä–∏–ø—Ç—ã** - –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã

–ü—Ä–∏–º–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ Python:

```python
import psycopg2
import pandas as pd

conn = psycopg2.connect(
    host='localhost',
    port=5432,
    database='goszakup',
    user='goszakup',
    password='goszakup123'
)

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ pandas
df = pd.read_sql('SELECT * FROM v_contracts', conn)
print(df.head())
```

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ö–∞–∫–∞—Ç–æ–Ω–∞ ForteBank.

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License

---

**–£–¥–∞—á–∏ –Ω–∞ —Ö–∞–∫–∞—Ç–æ–Ω–µ!** üöÄ
